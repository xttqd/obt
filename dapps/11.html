<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>11</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body>
    <div class="container min-vh-100 d-flex align-items-center justify-content-center">
        <div class="position-fixed bottom-0 end-0 p-3">
            <button class="btn btn-outline-primary rounded-circle" type="button" data-bs-toggle="modal"
                data-bs-target="#settingsModal" style="width: 3rem; height: 3rem;">
                <i class="bi bi-gear"></i>
            </button>
        </div>

        <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="settingsModalLabel">–ê–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="votingAddress" class="form-label">Voting Contract</label>
                            <input type="text" class="form-control" id="votingAddress">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="updateAddress">–û–±–Ω–æ–≤–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            –∞–¥—Ä–µ—Å</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-100">
            <div class="row g-4 justify-content-center">
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex align-items-center justify-content-center" style="height: 80px;">
                            <h5 class="mb-0 text-center">–°–º–µ–Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–∞</h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="mt-auto">
                                <div class="mb-3">
                                    <label class="form-label">–¢–µ–∫—É—â–∏–π –∞–∫–∫–∞—É–Ω—Ç:</label>
                                    <input type="text" class="form-control" id="currentAccount" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="newAccount" class="form-label">–ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç:</label>
                                    <select class="form-select" id="newAccount">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç</option>
                                    </select>
                                </div>
                                <div id="switchAccountResult" class="my-3"></div>
                            </div>
                            <button class="btn btn-primary w-100 mt-auto" id="switchAccount">–°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex align-items-center justify-content-center" style="height: 80px;">
                            <h5 class="mb-0 text-center">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="mt-auto">
                                <div class="mb-3">
                                    <label for="voteCandidate" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</label>
                                    <select class="form-select" id="voteCandidate">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</option>
                                    </select>
                                </div>
                                <div id="voteResult" class="my-3"></div>
                            </div>
                            <button class="btn btn-primary w-100 mt-auto" id="vote">–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex align-items-center justify-content-center" style="height: 80px;">
                            <h5 class="mb-0 text-center">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div id="votingResults" class="mb-3"></div>
                            <button class="btn btn-primary w-100 mt-auto" id="updateResults">–û–±–Ω–æ–≤–∏—Ç—å
                                —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <script>
        let votingContract;
        let settingsModal;
        let web3;
        let currentAccount;

        function loadAddress() {
            const savedAddress = localStorage.getItem('votingAddress');
            if (savedAddress) {
                $('#votingAddress').val(savedAddress);
                return savedAddress;
            }
            return null;
        }

        function saveAddress() {
            const address = $('#votingAddress').val();
            localStorage.setItem('votingAddress', address);
        }

        async function loadAccounts() {
            try {
                if (!web3) {
                    console.error('Web3 –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    return;
                }

                const accounts = await web3.eth.getAccounts();
                const select = $('#newAccount');
                select.empty();
                select.append('<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç</option>');

                accounts.forEach(account => {
                    const shortAddress = account.slice(0, 6) + '...' + account.slice(-4);
                    select.append(`<option value="${account}">${shortAddress}</option>`);
                });

                if (!currentAccount && accounts.length > 0) {
                    currentAccount = accounts[0];
                    $('#currentAccount').val(currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤:', error);
            }
        }

        async function updateCandidatesList() {
            try {
                let i = 0;
                const candidates = [];
                
                while (true) {
                    try {
                        const candidate = await votingContract.methods.candidateList(i).call();
                        candidates.push(candidate);
                        i++;
                    } catch (error) {
                        break;
                    }
                }

                const voteSelect = $('#voteCandidate');
                voteSelect.empty();
                voteSelect.append('<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</option>');
                
                candidates.forEach(candidate => {
                    const name = web3.utils.hexToUtf8(candidate);
                    voteSelect.append(`<option value="${candidate}">${name}</option>`);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:', error);
            }
        }

        async function updateVotingResults() {
            try {
                let i = 0;
                const candidates = [];
                const results = [];
                
                while (true) {
                    try {
                        const candidate = await votingContract.methods.candidateList(i).call();
                        candidates.push(candidate);
                        i++;
                    } catch (error) {
                        break;
                    }
                }

                // –ü–æ–ª—É—á–∞–µ–º –≥–æ–ª–æ—Å–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
                for (const candidate of candidates) {
                    const votes = await votingContract.methods.totalVotesFor(candidate).call();
                    const name = web3.utils.hexToUtf8(candidate);
                    results.push({ name, votes: parseInt(votes), candidate });
                }

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≥–æ–ª–æ—Å–æ–≤ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
                results.sort((a, b) => b.votes - a.votes);

                const resultsDiv = $('#votingResults');
                resultsDiv.empty();

                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
                results.forEach((result, index) => {
                    const place = index + 1;
                    const medal = place === 1 ? 'ü•á' : place === 2 ? 'ü•à' : place === 3 ? 'ü•â' : `${place}.`;
                    
                    resultsDiv.append(`
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <span class="me-2">${medal}</span>
                                <span class="fw-bold">${result.name}</span>
                                <span class="ms-auto">${result.votes} –≥–æ–ª–æ—Å–æ–≤</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: ${result.votes}%" 
                                     aria-valuenow="${result.votes}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                    `);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
                $('#votingResults').html(`<div class="text-danger">–û—à–∏–±–∫–∞: ${error.message}</div>`);
            }
        }

        async function init() {
            try {
                web3 = new Web3('http://localhost:8545');

                const votingAddress = $('#votingAddress').val();
                if (!votingAddress) {
                    console.error('–ê–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    return;
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫–∫–∞—É–Ω—Ç –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                const accounts = await web3.eth.getAccounts();
                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    $('#currentAccount').val(currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4));
                }

                votingContract = new web3.eth.Contract([
                    {
                        "inputs": [],
                        "stateMutability": "nonpayable",
                        "type": "constructor"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "candidate",
                                "type": "bytes32"
                            }
                        ],
                        "name": "voteForCandidate",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "name": "candidateList",
                        "outputs": [
                            {
                                "internalType": "bytes32",
                                "name": "",
                                "type": "bytes32"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "user",
                                "type": "address"
                            }
                        ],
                        "name": "hasUserVoted",
                        "outputs": [
                            {
                                "internalType": "bool",
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                        ],
                        "name": "hasVoted",
                        "outputs": [
                            {
                                "internalType": "bool",
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "candidate",
                                "type": "bytes32"
                            }
                        ],
                        "name": "totalVotesFor",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "candidate",
                                "type": "bytes32"
                            }
                        ],
                        "name": "validCandidate",
                        "outputs": [
                            {
                                "internalType": "bool",
                                "name": "",
                                "type": "bool"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "bytes32",
                                "name": "",
                                "type": "bytes32"
                            }
                        ],
                        "name": "votesReceived",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    }
                ], votingAddress);

                await updateCandidatesList();
                await updateVotingResults();
                await checkVotingStatus();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        async function checkVotingStatus() {
            try {
                if (!currentAccount) {
                    console.error('–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω');
                    return;
                }

                const hasVoted = await votingContract.methods.hasUserVoted(currentAccount).call();

                if (hasVoted) {
                    $('#vote').prop('disabled', true);
                    $('#voteResult').html('<div class="alert alert-info">–í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏</div>');
                } else {
                    $('#vote').prop('disabled', false);
                    $('#voteResult').empty();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:', error);
                $('#voteResult').html(`<div class="alert alert-danger">–û—à–∏–±–∫–∞: ${error.message}</div>`);
            }
        }

        $(document).ready(async function () {
            loadAddress();
            await init();
            await loadAccounts();

            settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));

            $('#updateAddress').click(async function () {
                saveAddress();
                await init();
                await loadAccounts();
                alert('–ê–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                settingsModal.hide();
            });

            $('#switchAccount').click(async function () {
                try {
                    const newAccount = $('#newAccount').val();
                    if (!newAccount) {
                        $('#switchAccountResult').html('<div class="alert alert-danger">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</div>');
                        return;
                    }
                    currentAccount = newAccount;
                    $('#currentAccount').val(currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4));
                    $('#switchAccountResult').html('<div class="alert alert-success">–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!</div>');
                    await checkVotingStatus();
                } catch (error) {
                    $('#switchAccountResult').html(`<div class="alert alert-danger">–û—à–∏–±–∫–∞: ${error.message}</div>`);
                }
            });

            $('#vote').click(async function () {
                try {
                    const candidate = $('#voteCandidate').val();
                    if (!candidate) {
                        $('#voteResult').html('<div class="alert alert-danger">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</div>');
                        return;
                    }

                    await votingContract.methods.voteForCandidate(candidate).send({ from: currentAccount });
                    $('#voteResult').html('<div class="alert alert-success">–ì–æ–ª–æ—Å —É—Å–ø–µ—à–Ω–æ –æ—Ç–¥–∞–Ω!</div>');
                    $('#vote').prop('disabled', true);
                    await updateVotingResults();
                } catch (error) {
                    $('#voteResult').html(`<div class="alert alert-danger">–û—à–∏–±–∫–∞: ${error.message}</div>`);
                }
            });

            $('#updateResults').click(async function () {
                await updateVotingResults();
            });
        });
    </script>
</body>

</html>